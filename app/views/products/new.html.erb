<html>
<head>

    <title></title>
</head>

<script type="text/javascript" 
        src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>

<script type="text/javascript">
$(document).ready(function()
{   
    function getWattingList(){
       $.ajax({ 
         type: 'GET',
         url: '/get_watting_list',
         success: function(data,status,xhr){
           $('#home_url_list').html("<div class='user_url_info' id=url_list><p id='url_list'>현재 "+data.message+" 개의 상품이 분류 중입니다.</p></div>");
         },
         error: function(xhr,status,error){
           console.log(xhr);
           alert(error);
         }
       });
     }

    function refresh(){
       $.ajax({ 
         type: 'GET',
         url: '/get_aj',
         success: function(data,status,xhr){
           //console.log(data);
           $('#header_product_count').html(data.message);
           //$('#home_url_list').html("<div class='user_url_info' id=url_list>현재 "+<%=@current_user_products.count%>+"개의 상품이 분류 중입니다.</div>");
           getWattingList();
         },
         error: function(xhr,status,error){
           console.log(xhr);
           alert(error);
         }
       });
     }

    //bitly를 이용해 shorten ajax 처리
    function bit_shorten_url(url){ 
        var username="limjungmok"; // bit.ly username
        var key="R_249fbb5a23da46259abafefc07de6d0e";// bit.ly API KEY
        $.ajax({
            url:"http://api.bit.ly/v3/shorten",
            data:{longUrl:url,apiKey:key,login:username},
            dataType:"jsonp",
            success:function(v){
                var shorten_url=v.data.url;
                submit_url(shorten_url);
                bit_expand_url(shorten_url);
            }
        });
    }
    //bitly를 이용해 expand ajax 처리
    function bit_expand_url(url){
        var key="becb860398ed9e74775cd8dc8a5bf1724caeb2f1";
        console.log("aa",url);
        $.ajax({
            url:"https://api-ssl.bitly.com/v3/expand?access_token="+key+"&shortUrl="+url+"&format=txt",
            type:"GET",
            success:function(v){
                console.log(v);
            }
        });
    }
    //URL 축소된 url을 전송하는 함수
    function submit_url(url){
        var shorten_url = url;
        console.log("shorten url : ", shorten_url);
        $.ajax({
            url:"/users/<%=current_user.id%>/products",
            type:'POST',
            data:{'url':url},
            success:function(v){
                //$('#home_url_list').append("<div class='user_url_info' id=url_list><a href ="+url+" target=_blank>"+url+"</a> <a id='delete_product' disabled></a></div>");
                document.getElementById("short").disabled = false;
                //document.getElementById("short").value = "제출";
                refresh();
            }
        });
    }
    //URL 을 파싱한 뒤, 비틀리로 줄이기 위한 함수
    function parsing_url(){
        var url=$("#url").val();
        //$('body').html(url);
        var urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        var urltest=urlRegex.test(url);

        if(urltest){
            document.getElementById("short").disabled = true;
            //document.getElementById("short").value = "제출중";
            //URL 을 축소시킨다. 
            bit_shorten_url(url);
        }else{
            alert("Bad URL");
        }
    }
    
    //Submit 버튼 클릭시
    $("#short").click(function()
    {
        console.log("submit");
        parsing_url();
        
    });

    //URL 엔터키 먹였을때.
    $("#url").keydown(function(e){
        if(e.keyCode == 13){
            console.log("enter");
            parsing_url();
        }else{

        }
    });
});

</script>

<body>
    <div class="form-inline" align="center">
        <div id="home_url_form">
            <div id="home_url_input" align="center" class="form-group">
                <input type="text" name="url" id="url" class="form-control" placeholder="URL 을 입력하세요" />
                <button type="submit" id="short" class="btn btn-default" />
            </div>
            
            <div id="home_url_list" align="left">
                <div class="user_url_info" id="url_list">
                <p id="url_list">현재 <%=@current_user_products.count%> 개의 상품이 분류 중입니다.</p>
                </div>
            </div> 
        </div>
    </div>
</body>

</html>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-73008078-1', 'auto');
    ga('send', 'pageview');
</script>